# Спецификация API интеграции с WMS 1С

## Обзор

Данный документ описывает HTTP API для получения сырых данных из WMS системы на платформе 1С. Вся аналитика и ML-обработка выполняется на стороне Buffer Management System.

### Принцип интеграции

```
┌─────────────────────┐                            ┌─────────────────────┐
│                     │  GET /tasks?after={id}     │                     │
│  Buffer Management  │ ◄───────────────────────── │     WMS 1С          │
│       System        │       Сырые данные         │   (источник)        │
│                     │                            │                     │
│  • Анализ           │  GET /pickers?after={id}   │  • Таблица заданий  │
│  • Агрегация        │ ◄───────────────────────── │  • Сборщики         │
│  • ML обучение      │       Инкрементально       │  • Карщики          │
│  • TimescaleDB      │                            │  • Палеты           │
└─────────────────────┘                            └─────────────────────┘
```

### Базовые требования

- **Протокол**: HTTP/HTTPS
- **Формат данных**: JSON (UTF-8)
- **Аутентификация**: API Key в заголовке `X-API-Key`
- **Базовый URL**: `http://<wms-server>/wms/hs/buffer-api/v1`
- **Инкрементальная загрузка**: параметр `after` — ID последней загруженной записи

---

## Аутентификация

```http
X-API-Key: <api_key>
```

Или Basic Auth:
```http
Authorization: Basic <base64(login:password)>
```

---

## Общие принципы

### Инкрементальная загрузка

Все endpoints поддерживают параметр `after` для дозагрузки данных:

```http
GET /tasks?after=00000000-0000-0000-0000-000000000000&limit=1000
```

- Первый запрос: `after` не указан или `after=00000000-0000-0000-0000-000000000000`
- Последующие запросы: `after={lastId}` — ID последней полученной записи
- Записи отсортированы по ID (или времени изменения)
- Если `hasMore=true` — есть ещё данные

### Формат ответа

```json
{
  "items": [...],
  "lastId": "abc123",
  "hasMore": true
}
```

| Поле | Описание |
|------|----------|
| `items` | Массив записей |
| `lastId` | ID последней записи (использовать в следующем запросе) |
| `hasMore` | Есть ли ещё данные |

---

## Справочники (Enums)

### СтатусЗадания (TaskStatus)

| Код | Значение 1С | Описание |
|-----|-------------|----------|
| 0 | `Новое` | Создано |
| 1 | `Назначено` | Назначено карщику |
| 2 | `ВРаботе` | Выполняется |
| 3 | `Завершено` | Успешно завершено |
| 4 | `Ошибка` | Ошибка выполнения |
| 5 | `Отменено` | Отменено |

### СтатусСборщика (PickerStatus)

| Код | Значение 1С | Описание |
|-----|-------------|----------|
| 0 | `Ожидание` | Ожидает работу |
| 1 | `Работает` | Собирает заказ |
| 2 | `Перерыв` | На перерыве |
| 3 | `НеВСети` | Не работает |

### СтатусКарщика (ForkliftStatus)

| Код | Значение 1С | Описание |
|-----|-------------|----------|
| 0 | `Свободен` | Ожидает задание |
| 1 | `ВПути` | Едет к палете/буферу |
| 2 | `Загрузка` | Забирает палету |
| 3 | `Разгрузка` | Ставит палету |
| 4 | `ТехОбслуживание` | На ремонте |

### СтатусПалеты (PalletStatus)

| Код | Значение 1С | Описание |
|-----|-------------|----------|
| 0 | `НаХранении` | В зоне хранения |
| 1 | `Зарезервирована` | Зарезервирована для задания |
| 2 | `ВПеремещении` | Перевозится |
| 3 | `ВБуфере` | В зоне буфера |
| 4 | `Израсходована` | Полностью разобрана |

---

## API Endpoints

### 1. Проверка доступности

#### `GET /health`

```http
GET /wms/hs/buffer-api/v1/health
```

**Ответ:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "1.0"
}
```

---

### 2. Задания (основная таблица)

#### `GET /tasks`

Получить записи из таблицы заданий.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `after` | `string` | Нет | ID последней загруженной записи |
| `limit` | `int` | Нет | Максимум записей (по умолчанию 1000, макс 10000) |
| `modifiedAfter` | `datetime` | Нет | Записи изменённые после указанного времени |

**Пример:**
```http
GET /wms/hs/buffer-api/v1/tasks?after=task-12345&limit=1000
X-API-Key: your-api-key
```

**Ответ:**
```json
{
  "items": [
    {
      "id": "task-12346",
      "createdAt": "2024-01-15T10:30:00Z",
      "modifiedAt": "2024-01-15T10:35:00Z",
      "startedAt": "2024-01-15T10:31:00Z",
      "completedAt": "2024-01-15T10:35:00Z",
      "status": 3,
      "palletId": "PAL-001",
      "productSku": "SKU-001",
      "productName": "Товар 1",
      "quantity": 100,
      "weightKg": 250.5,
      "forkliftId": "FORK-001",
      "forkliftOperator": "Петров П.П.",
      "fromZone": "STORAGE-A",
      "fromSlot": "A-01-02-03",
      "fromX": 10.5,
      "fromY": 20.3,
      "toZone": "BUFFER",
      "toSlot": "BUF-01",
      "toX": 50.0,
      "toY": 10.0,
      "distanceMeters": 45.5,
      "failureReason": null
    }
  ],
  "lastId": "task-12346",
  "hasMore": true
}
```

**Поля записи задания:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `string` | Уникальный ID задания |
| `createdAt` | `datetime` | Дата создания |
| `modifiedAt` | `datetime` | Дата последнего изменения |
| `startedAt` | `datetime?` | Дата начала выполнения |
| `completedAt` | `datetime?` | Дата завершения |
| `status` | `int` | Статус (0-5) |
| `palletId` | `string` | ID палеты |
| `productSku` | `string` | Артикул товара |
| `productName` | `string` | Наименование товара |
| `quantity` | `int` | Количество единиц на палете |
| `weightKg` | `number` | Вес палеты (кг) |
| `forkliftId` | `string?` | ID карщика |
| `forkliftOperator` | `string?` | ФИО оператора |
| `fromZone` | `string` | Зона отправления |
| `fromSlot` | `string` | Ячейка отправления |
| `fromX` | `number` | Координата X отправления |
| `fromY` | `number` | Координата Y отправления |
| `toZone` | `string` | Зона назначения |
| `toSlot` | `string` | Ячейка назначения |
| `toX` | `number` | Координата X назначения |
| `toY` | `number` | Координата Y назначения |
| `distanceMeters` | `number?` | Расстояние (метры) |
| `failureReason` | `string?` | Причина ошибки |

---

### 3. Сборщики

#### `GET /pickers`

Получить текущее состояние сборщиков.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `after` | `string` | Нет | ID последней загруженной записи |
| `limit` | `int` | Нет | Максимум записей |

**Ответ:**
```json
{
  "items": [
    {
      "id": "EMP-001",
      "name": "Иванов И.И.",
      "status": 1,
      "zone": "PICKING-A",
      "currentOrderId": "ORD-123",
      "shiftStart": "2024-01-15T08:00:00Z",
      "shiftEnd": "2024-01-15T20:00:00Z",
      "palletsToday": 25,
      "itemsToday": 450
    }
  ],
  "lastId": "EMP-001",
  "hasMore": false
}
```

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `string` | Табельный номер |
| `name` | `string` | ФИО |
| `status` | `int` | Статус (0-3) |
| `zone` | `string` | Рабочая зона |
| `currentOrderId` | `string?` | Текущий заказ |
| `shiftStart` | `datetime` | Начало смены |
| `shiftEnd` | `datetime?` | Конец смены |
| `palletsToday` | `int` | Палет обработано за смену |
| `itemsToday` | `int` | Единиц собрано за смену |

---

### 4. История активности сборщиков

#### `GET /picker-activity`

Лог активности сборщиков (события начала/окончания работы с палетой).

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `after` | `string` | Нет | ID последней записи |
| `limit` | `int` | Нет | Максимум записей |
| `fromTime` | `datetime` | Нет | Записи после указанного времени |

**Ответ:**
```json
{
  "items": [
    {
      "id": "ACT-00001",
      "timestamp": "2024-01-15T10:30:00Z",
      "pickerId": "EMP-001",
      "eventType": "pallet_start",
      "palletId": "PAL-001",
      "orderId": "ORD-123",
      "itemsPicked": null,
      "durationSec": null
    },
    {
      "id": "ACT-00002",
      "timestamp": "2024-01-15T10:35:00Z",
      "pickerId": "EMP-001",
      "eventType": "pallet_end",
      "palletId": "PAL-001",
      "orderId": "ORD-123",
      "itemsPicked": 45,
      "durationSec": 300
    }
  ],
  "lastId": "ACT-00002",
  "hasMore": true
}
```

**Типы событий (eventType):**

| Значение | Описание |
|----------|----------|
| `shift_start` | Начало смены |
| `shift_end` | Конец смены |
| `break_start` | Начало перерыва |
| `break_end` | Конец перерыва |
| `pallet_start` | Начал работу с палетой |
| `pallet_end` | Закончил работу с палетой |
| `order_start` | Начал сборку заказа |
| `order_end` | Закончил сборку заказа |

---

### 5. Карщики

#### `GET /forklifts`

Получить текущее состояние карщиков.

**Ответ:**
```json
{
  "items": [
    {
      "id": "FORK-001",
      "operatorId": "EMP-010",
      "operatorName": "Петров П.П.",
      "status": 1,
      "currentTaskId": "task-12346",
      "positionX": 25.5,
      "positionY": 15.0,
      "lastUpdateAt": "2024-01-15T10:35:00Z"
    }
  ],
  "lastId": "FORK-001",
  "hasMore": false
}
```

**Поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `string` | ID погрузчика |
| `operatorId` | `string` | Табельный номер оператора |
| `operatorName` | `string` | ФИО оператора |
| `status` | `int` | Статус (0-4) |
| `currentTaskId` | `string?` | Текущее задание |
| `positionX` | `number` | Координата X |
| `positionY` | `number` | Координата Y |
| `lastUpdateAt` | `datetime` | Время последнего обновления |

---

### 6. Палеты

#### `GET /pallets`

Получить информацию о палетах.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `after` | `string` | Нет | ID последней записи |
| `limit` | `int` | Нет | Максимум записей |
| `zone` | `string` | Нет | Фильтр по зоне |
| `status` | `int` | Нет | Фильтр по статусу |

**Ответ:**
```json
{
  "items": [
    {
      "id": "PAL-001",
      "productSku": "SKU-001",
      "productName": "Товар 1",
      "quantity": 100,
      "weightKg": 250.5,
      "zone": "STORAGE-A",
      "slot": "A-01-02-03",
      "positionX": 10.5,
      "positionY": 20.3,
      "positionZ": 2.0,
      "status": 0,
      "createdAt": "2024-01-10T08:00:00Z",
      "lastMovedAt": "2024-01-15T08:00:00Z"
    }
  ],
  "lastId": "PAL-001",
  "hasMore": true
}
```

---

### 7. Состояние буфера

#### `GET /buffer`

Получить текущее состояние зоны буфера.

**Ответ:**
```json
{
  "timestamp": "2024-01-15T10:35:00Z",
  "capacity": 50,
  "currentCount": 32,
  "pallets": [
    {
      "id": "PAL-001",
      "slot": "BUF-01",
      "productSku": "SKU-001",
      "productName": "Товар 1",
      "quantity": 100,
      "weightKg": 250.5,
      "arrivedAt": "2024-01-15T10:30:00Z"
    }
  ]
}
```

---

### 8. Снимки буфера (история)

#### `GET /buffer-snapshots`

История состояния буфера (записывается периодически в 1С).

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `after` | `string` | Нет | ID последней записи |
| `limit` | `int` | Нет | Максимум записей |
| `fromTime` | `datetime` | Нет | Записи после указанного времени |

**Ответ:**
```json
{
  "items": [
    {
      "id": "SNAP-00001",
      "timestamp": "2024-01-15T10:30:00Z",
      "capacity": 50,
      "currentCount": 32,
      "activeForklifts": 3,
      "activePickers": 18
    }
  ],
  "lastId": "SNAP-00001",
  "hasMore": true
}
```

**Рекомендация:** записывать снимок в 1С каждые 30-60 секунд.

---

### 9. Заказы

#### `GET /orders`

Получить заказы для планирования волн.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `after` | `string` | Нет | ID последней записи |
| `limit` | `int` | Нет | Максимум записей |
| `status` | `string` | Нет | Фильтр: `active`, `completed`, `all` |

**Ответ:**
```json
{
  "items": [
    {
      "id": "ORD-001",
      "createdAt": "2024-01-15T10:00:00Z",
      "dueTime": "2024-01-15T14:00:00Z",
      "priority": 1,
      "status": "active",
      "customerId": "CUST-001",
      "customerName": "ООО Рога и Копыта",
      "totalItems": 150,
      "totalWeight": 450.5,
      "lines": [
        {
          "productSku": "SKU-001",
          "productName": "Товар 1",
          "quantity": 50,
          "weightKg": 150.0
        }
      ]
    }
  ],
  "lastId": "ORD-001",
  "hasMore": true
}
```

---

## Команды (запись в WMS)

### 10. Создать задание

#### `POST /tasks`

**Запрос:**
```json
{
  "palletId": "PAL-001",
  "fromZone": "STORAGE-A",
  "fromSlot": "A-01-02-03",
  "toZone": "BUFFER",
  "toSlot": "BUF-01",
  "priority": 2,
  "forkliftId": "FORK-001"
}
```

**Ответ:**
```json
{
  "taskId": "task-12347",
  "success": true
}
```

### 11. Обновить статус задания

#### `PUT /tasks/{taskId}/status`

**Запрос:**
```json
{
  "status": 3,
  "completedAt": "2024-01-15T10:35:00Z",
  "failureReason": null
}
```

**Ответ:**
```json
{
  "success": true
}
```

### 12. Зарезервировать палету

#### `POST /pallets/{palletId}/reserve`

**Запрос:**
```json
{
  "forkliftId": "FORK-001",
  "taskId": "task-12347",
  "timeoutMinutes": 10
}
```

**Ответ:**
```json
{
  "success": true,
  "reservationId": "RES-001",
  "expiresAt": "2024-01-15T10:45:00Z"
}
```

### 13. Освободить резервацию

#### `DELETE /pallets/{palletId}/reserve`

**Ответ:**
```json
{
  "success": true
}
```

---

## Коды ошибок

| HTTP Код | Описание |
|----------|----------|
| 200 | Успешно |
| 201 | Создано |
| 400 | Неверный запрос |
| 401 | Не авторизован |
| 404 | Не найдено |
| 409 | Конфликт (палета уже зарезервирована) |
| 500 | Ошибка сервера |

**Формат ошибки:**
```json
{
  "error": {
    "code": "PALLET_RESERVED",
    "message": "Палета уже зарезервирована",
    "details": {
      "palletId": "PAL-001",
      "reservedBy": "FORK-002"
    }
  }
}
```

---

## Реализация в 1С

### Структура HTTP-сервиса

```
Конфигурация
└── HTTP-сервисы
    └── BufferAPI
        ├── Корневой URL: /wms/hs/buffer-api/v1
        └── Шаблоны URL:
            ├── /health (GET)
            ├── /tasks (GET, POST)
            ├── /tasks/{taskId}/status (PUT)
            ├── /pickers (GET)
            ├── /picker-activity (GET)
            ├── /forklifts (GET)
            ├── /pallets (GET)
            ├── /pallets/{palletId}/reserve (POST, DELETE)
            ├── /buffer (GET)
            ├── /buffer-snapshots (GET)
            └── /orders (GET)
```

### Пример реализации /tasks в 1С

```bsl
Функция ПолучитьЗадания(Запрос)

    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");

    // Параметры
    ПоследнийID = Запрос.ПараметрыЗапроса.Получить("after");
    Лимит = Число(Запрос.ПараметрыЗапроса.Получить("limit"));
    Если Лимит = 0 Тогда Лимит = 1000; КонецЕсли;
    Если Лимит > 10000 Тогда Лимит = 10000; КонецЕсли;

    // Запрос к БД
    Запрос1С = Новый Запрос;
    Запрос1С.Текст =
    "ВЫБРАТЬ ПЕРВЫЕ &Лимит
    |   Задания.Код КАК id,
    |   Задания.ДатаСоздания КАК createdAt,
    |   Задания.ДатаИзменения КАК modifiedAt,
    |   Задания.ДатаНачала КАК startedAt,
    |   Задания.ДатаЗавершения КАК completedAt,
    |   ВЫБОР
    |       КОГДА Задания.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданий.Новое) ТОГДА 0
    |       КОГДА Задания.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданий.Назначено) ТОГДА 1
    |       КОГДА Задания.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданий.ВРаботе) ТОГДА 2
    |       КОГДА Задания.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданий.Завершено) ТОГДА 3
    |       КОГДА Задания.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданий.Ошибка) ТОГДА 4
    |       КОГДА Задания.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданий.Отменено) ТОГДА 5
    |   КОНЕЦ КАК status,
    |   Задания.Палета.Код КАК palletId,
    |   Задания.Палета.Номенклатура.Артикул КАК productSku,
    |   Задания.Палета.Номенклатура.Наименование КАК productName,
    |   Задания.Палета.Количество КАК quantity,
    |   Задания.Палета.ВесБрутто КАК weightKg,
    |   Задания.Карщик.Код КАК forkliftId,
    |   Задания.Карщик.Оператор.Наименование КАК forkliftOperator,
    |   Задания.ЗонаОтправления.Код КАК fromZone,
    |   Задания.ЯчейкаОтправления.Код КАК fromSlot,
    |   Задания.ЯчейкаОтправления.КоординатаX КАК fromX,
    |   Задания.ЯчейкаОтправления.КоординатаY КАК fromY,
    |   Задания.ЗонаНазначения.Код КАК toZone,
    |   Задания.ЯчейкаНазначения.Код КАК toSlot,
    |   Задания.ЯчейкаНазначения.КоординатаX КАК toX,
    |   Задания.ЯчейкаНазначения.КоординатаY КАК toY,
    |   Задания.Расстояние КАК distanceMeters,
    |   Задания.ПричинаОшибки КАК failureReason
    |ИЗ
    |   Документ.ЗаданиеНаПеремещение КАК Задания
    |ГДЕ
    |   Задания.Код > &ПоследнийID
    |УПОРЯДОЧИТЬ ПО
    |   Задания.Код";

    Запрос1С.УстановитьПараметр("ПоследнийID", ?(ПустаяСтрока(ПоследнийID), "", ПоследнийID));
    Запрос1С.УстановитьПараметр("Лимит", Лимит + 1); // +1 для определения hasMore

    Выборка = Запрос1С.Выполнить().Выбрать();

    // Формируем результат
    МассивЗаданий = Новый Массив;
    ПоследнийIDРезультата = "";
    Счетчик = 0;

    Пока Выборка.Следующий() И Счетчик < Лимит Цикл
        Задание = Новый Структура;
        Задание.Вставить("id", Выборка.id);
        Задание.Вставить("createdAt", ФорматISO8601(Выборка.createdAt));
        Задание.Вставить("modifiedAt", ФорматISO8601(Выборка.modifiedAt));
        Задание.Вставить("startedAt", ФорматISO8601(Выборка.startedAt));
        Задание.Вставить("completedAt", ФорматISO8601(Выборка.completedAt));
        Задание.Вставить("status", Выборка.status);
        Задание.Вставить("palletId", Выборка.palletId);
        Задание.Вставить("productSku", Выборка.productSku);
        Задание.Вставить("productName", Выборка.productName);
        Задание.Вставить("quantity", Выборка.quantity);
        Задание.Вставить("weightKg", Выборка.weightKg);
        Задание.Вставить("forkliftId", Выборка.forkliftId);
        Задание.Вставить("forkliftOperator", Выборка.forkliftOperator);
        Задание.Вставить("fromZone", Выборка.fromZone);
        Задание.Вставить("fromSlot", Выборка.fromSlot);
        Задание.Вставить("fromX", Выборка.fromX);
        Задание.Вставить("fromY", Выборка.fromY);
        Задание.Вставить("toZone", Выборка.toZone);
        Задание.Вставить("toSlot", Выборка.toSlot);
        Задание.Вставить("toX", Выборка.toX);
        Задание.Вставить("toY", Выборка.toY);
        Задание.Вставить("distanceMeters", Выборка.distanceMeters);
        Задание.Вставить("failureReason", Выборка.failureReason);

        МассивЗаданий.Добавить(Задание);
        ПоследнийIDРезультата = Выборка.id;
        Счетчик = Счетчик + 1;
    КонецЦикла;

    // Определяем hasMore
    ЕстьЕще = Выборка.Следующий();

    Результат = Новый Структура;
    Результат.Вставить("items", МассивЗаданий);
    Результат.Вставить("lastId", ПоследнийIDРезультата);
    Результат.Вставить("hasMore", ЕстьЕще);

    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, Результат);

    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
    Возврат Ответ;

КонецФункции

Функция ФорматISO8601(Дата)
    Если Не ЗначениеЗаполнено(Дата) Тогда
        Возврат Null;
    КонецЕсли;
    Возврат Формат(Дата, "ДФ=yyyy-MM-ddTHH:mm:ssZ");
КонецФункции
```

---

## Частота синхронизации

| Endpoint | Частота | Описание |
|----------|---------|----------|
| `/tasks` | 5-10 сек | Основные данные |
| `/pickers` | 30 сек | Состояние сборщиков |
| `/picker-activity` | 30 сек | Лог активности |
| `/forklifts` | 5 сек | Состояние карщиков |
| `/buffer` | 5 сек | Текущее состояние буфера |
| `/buffer-snapshots` | 60 сек | История буфера |
| `/pallets` | 60 сек | Реестр палет |
| `/orders` | 60 сек | Заказы |

---

## Схема данных на стороне Buffer Management

```
┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐
│   WMS 1С API     │      │  Data Sync       │      │   TimescaleDB    │
│                  │ ───► │  Service         │ ───► │                  │
│  /tasks          │      │                  │      │  tasks           │
│  /pickers        │      │  • Polling       │      │  picker_metrics  │
│  /forklifts      │      │  • last_id track │      │  buffer_snapshots│
│  /buffer         │      │  • Transform     │      │                  │
└──────────────────┘      └──────────────────┘      └──────────────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │  Buffer Control  │
                          │                  │
                          │  • State Machine │
                          │  • Dispatcher    │
                          │  • ML Predictor  │
                          └──────────────────┘
```

Приложение Buffer Management:
1. Периодически запрашивает данные с `after={lastId}`
2. Сохраняет сырые данные в TimescaleDB
3. Рассчитывает агрегаты (скорость, эффективность) самостоятельно
4. Обучает ML модели на накопленных данных
